<tool id="fastspar_pvalues" name="FastSpar estimate p-values" version="@TOOL_VERSION@+@VERSION_SUFFIX@" python_template_version="3.5" profile="21.05">
    <description>
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
	    mkdir bootstrap_counts
	 && fastspar_bootstrap
			--otu_table $otu_table
			--number $number
			--prefix bootstrap_counts/data
			--seed $seed
			--threads \${GALAXY_SLOTS:-1}
		
	 && mkdir bootstrap_correlation
	 && parallel
			--max-procs \${GALAXY_SLOTS:-1}
			fastspar
				--otu_table {}
				--correlation bootstrap_correlation/cor_{/}
				--covariance bootstrap_correlation/cov_{/}
				## should --iterations be the same as for the main analysis?
				--iterations 5
				## should I also add --exclude_iterations, --threshold and/or --seed?
			::: bootstrap_counts/*
		
	 && fastspar_pvalues
			--otu_table $otu_table
			--correlation $correlation
			--prefix bootstrap_correlation/cor_data_
			--permutations $number
			$pseudo
			--threads \${GALAXY_SLOTS:-1}
			--outfile $pvalues
    ]]></command>
    <inputs>
		<param argument="--otu_table" type="data" format="tabular" label="Input OTU table"
			   help="The table must have absolute OTU counts in BIOM format without metadata."/>
		<param argument="--correlation" type="data" format="tabular" label="Correlation table generated by FastSpar"/>
		<param argument="--number" type="integer" value="1000" label="Number of bootstrap samples"/>
		<param argument="--seed" type="integer" value="1" label="Random number seed for generating permutations"/>
		<param argument="--pseudo" type="boolean" truevalue="--pseudo" falsevalue=""
			   label="Calculate pseudo p-values rather than exact p-values"/>
	</inputs>
    <outputs>
		<data name="pvalues" format="tabular" label="${tool.name} on ${on_string}: pvalues.tsv"/>
    </outputs>
    <tests>
		<test expect_num_outputs="1">
            <param name="otu_table" ftype="tabular" value="fake_data.tsv"/>
            <param name="correlation" ftype="tabular" value="fake_data_cor.tsv"/>
            <param name="number" value="10"/>
            <output name="pvalues" file="fake_pvalues.tsv" compare="diff"/>
        </test>
    </tests>
    <help><![CDATA[
The p-values are calculated using a permutation based approach. For accurate results there needs be a sufficient number of bootstrap samples.

Please note that p-values generated by FastSpar should be adjusted for multiple testing to control the false-positive rate.
    ]]></help>
    <expand macro="citations"/>
</tool>