<tool id="fastspar_pvalues" name="FastSpar: estimate p-values" version="@TOOL_VERSION@+@VERSION_SUFFIX@" profile="24.2">
    <description>
		Bootstrap-based estimation of p-values from FastSpar correlations
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="biotools"/>
    <expand macro="requirements_pvalues"/>
    <command detect_errors="exit_code"><![CDATA[
	    mkdir bootstrap_counts
	 && fastspar_bootstrap
			--otu_table $otu_table
			--number $number
			--prefix bootstrap_counts/data
			--seed $seed
			--threads \${GALAXY_SLOTS:-1}
		
	 && mkdir bootstrap_correlation
	 && parallel
			--max-procs \${GALAXY_SLOTS:-1}
			fastspar
				--otu_table {}
				--correlation bootstrap_correlation/cor_{/}
				--covariance bootstrap_correlation/cov_{/}
				--iterations $iterations
				--exclude_iterations $exclude_iterations
				--threshold $threshold
				--seed $seed
			::: bootstrap_counts/*
		
	 && fastspar_pvalues
			--otu_table $otu_table
			--correlation $correlation
			--prefix bootstrap_correlation/cor_data_
			--permutations $number
			$pseudo
			--threads \${GALAXY_SLOTS:-1}
			--outfile $pvalues
    ]]></command>
    <inputs>
		<param argument="--otu_table" type="data" format="tabular" label="Input OTU table" help="The table must contain absolute OTU counts in plain tabular (TSV) format, with OTUs as rows and samples as columns. Do not include any metadata rows or columns."/>
		<param argument="--correlation" type="data" format="tabular" label="Correlation table" help="The correlation matrix generated by the original FastSpar analysis."/>
		<param argument="--number" type="integer" value="1000" min="10" max="10000" label="Number of bootstrap samples" help="Recommended minimum: 1000 bootstrap samples for robust estimation."/>
		<param argument="--iterations" type="integer" value="50" max="1000" label="Number of iterations" help="Must match the value used in the original FastSpar run."/>
		<param argument="--exclude_iterations" type="integer" value="10" max="100" label="Number of exclusion iterations" help="Must match the value used in the original FastSpar run."/>
		<param argument="--threshold" type="float" value="0.1" max="1.0" label="Exclusion threshold" help="Must match the value used in the original FastSpar run."/>
		<param argument="--seed" type="integer" value="1" label="Used to ensure reproducibility of bootstrapped samples."/>
		<param argument="--pseudo" type="boolean" truevalue="--pseudo" falsevalue="" label="Use pseudo p-values" help="If selected, pseudo p-values are calculated instead of exact p-values. This can provide faster estimates but may be less precise."/>
	</inputs>
    <outputs>
		<data name="pvalues" format="tabular" label="${tool.name} on ${on_string}: pvalues.tsv"/>
    </outputs>
    <tests>
		<test expect_num_outputs="1">
            <param name="otu_table" ftype="tabular" value="fake_data.tsv"/>
            <param name="correlation" ftype="tabular" value="fake_data_cor.tsv"/>
            <param name="number" value="10"/>
            <output name="pvalues" file="fake_pvalues.tsv" compare="diff"/>
        </test>
    </tests>
    <help><![CDATA[
What it does
============

This tool estimates **empirical p-values** for correlation values generated by FastSpar. It uses a **bootstrap-based permutation approach** to assess the statistical significance of observed correlations.

How it works
============

1. Generates multiple bootstrapped versions of the OTU table.
2. Runs FastSpar on each bootstrap replicate.
3. Compares bootstrapped correlations to the original correlation matrix to calculate empirical p-values.

Required Inputs
===============

- **OTU table**: TSV file with absolute counts (no metadata).
- **Correlation table**: Output from the original FastSpar run.
- **Bootstrap samples**: Number of bootstrap replicates (â‰¥1000 recommended).

Important Parameters
====================

- **Iterations**: Must match the number used in the original FastSpar run.
- **Exclude Iterations** and **Threshold**: Should also match the original settings, if used.
- **Seed**: Optional, for reproducibility.
- **Pseudo**: Choose whether to calculate pseudo p-values instead of exact values.

IMPORTANT
=========

For meaningful p-values, the parameters used during bootstrapped correlation estimation (**iterations, exclude iterations, threshold**) should be identical to those used in the original FastSpar run.

Output
======

- `pvalues.tsv`: A table of empirical p-values for all pairwise correlations.

Additional Resources
====================

- FastSpar GitHub: https://github.com/scwatts/fastspar
    ]]></help>
    <expand macro="citations"/>
</tool>