<tool id="phylophlan" name="PhyloPhlAn" version="0.1.0+galaxy0" python_template_version="3.5" profile="21.05">
    <description>
         microbial genome characterization and phylogenetic analysis
    </description>
	<requirements>
        <requirement type="package" version="3.1.1">phylophlan</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
		#import re
		
		mkdir -p 'database/' &&
		#for $d in $database
			#set $identifier = re.sub('[^\w\-\._]', '_', str($d.element_identifier))
			ln -s '$d' 'database/${identifier}' &&
		#end for
		ls -a database > $output1
	
	
        #*
		phylophlan
			-i input_isolates
			-o output_isolates
			-d database
			--trim greedy
			--not_variant_threshold 0.99
			--remove_fragmentary_entries
			--fragmentary_threshold 0.67
			--min_num_entries 4
			-t a
			-f isolates_config.cfg
			--diversity low
			--force_nucleotides
			--nproc 4
			--verbose
		*#
    ]]></command>
    <inputs>
		<!--<param name="input" type="data_collection" collection_type="list" label="Input Dataset"/>-->
		<param name="database" type="data_collection" collection_type="list" format="fasta" label="Database"/>
		<param name="config" type="data" format="toml" label="Configuration"/>
    </inputs>
    <outputs>
		<data name="output1" format="txt" />
    </outputs>
    <tests>
    </tests>
    <help><![CDATA[
        usage: phylophlan [-h] [-i INPUT | -c CLEAN] [-o OUTPUT] [-d DATABASE] [-t {n,a}] [-f CONFIG_FILE] --diversity
                  {low,medium,high} [--strainphlan] [--accurate | --fast] [--clean_all] [--database_list] [-s SUBMAT]
                  [--submat_list] [--submod_list] [--nproc NPROC] [--min_num_proteins MIN_NUM_PROTEINS]
                  [--min_len_protein MIN_LEN_PROTEIN] [--min_num_markers MIN_NUM_MARKERS]
                  [--trim {gap_trim,gap_perc,not_variant,greedy}] [--gap_perc_threshold GAP_PERC_THRESHOLD]
                  [--not_variant_threshold NOT_VARIANT_THRESHOLD]
                  [--subsample {phylophlan,onethousand,sevenhundred,fivehundred,threehundred,onehundred,fifty,twentyfive,tenpercent,twentyfivepercent,fiftypercent,full}]
                  [--unknown_fraction UNKNOWN_FRACTION] [--scoring_function {trident,muscle,random}] [--sort]
                  [--remove_fragmentary_entries] [--fragmentary_threshold FRAGMENTARY_THRESHOLD]
                  [--min_num_entries MIN_NUM_ENTRIES] [--maas MAAS] [--remove_only_gaps_entries] [--mutation_rates]
                  [--force_nucleotides] [--convert_N2gap] [--input_folder INPUT_FOLDER] [--data_folder DATA_FOLDER]
                  [--databases_folder DATABASES_FOLDER] [--submat_folder SUBMAT_FOLDER]
                  [--submod_folder SUBMOD_FOLDER] [--configs_folder CONFIGS_FOLDER] [--output_folder OUTPUT_FOLDER]
                  [--genome_extension GENOME_EXTENSION] [--proteome_extension PROTEOME_EXTENSION] [--update]
                  [--citation] [--verbose] [-v]

PhyloPhlAn is an accurate, rapid, and easy-to-use method for large-scale microbial genome characterization and
phylogenetic analysis at multiple levels of resolution. PhyloPhlAn can assign finished, draft, or metagenome-assembled
genomes (MAGs) to species-level genome bins (SGBs). For individual clades of interest (e.g. newly sequenced genome
sets), PhyloPhlAn reconstructs strain-level phylogenies from among the closest species using clade-specific maximally
informative markers. At the other extreme of resolution, PhyloPhlAn scales to very-large phylogenies comprising
>17,000 microbial species

options:
  -h, --help            show this help message and exit
  -i INPUT, --input INPUT
                        Folder containing your input genomes and/or proteomes (default: None)
  -c CLEAN, --clean CLEAN
                        Clean the output and partial data produced for the specified project (default: None)
  -o OUTPUT, --output OUTPUT
                        Output folder name, otherwise it will be the name of the input folder concatenated with the
                        name of the database used (default: None)
  -d DATABASE, --database DATABASE
                        The name of the database of markers to use (default: None)
  -t {n,a}, --db_type {n,a}
                        Specify the type of the database of markers, where "n" stands for nucleotides and "a" for
                        amino acids. If not specified, PhyloPhlAn will automatically detect the type of database
                        (default: None)
  -f CONFIG_FILE, --config_file CONFIG_FILE
                        The configuration file to use. Four ready-to-use configuration files can be generated using
                        the "phylophlan_write_default_configs.sh" script (default: None)
  --diversity {low,medium,high}
                        Specify the expected diversity of the phylogeny, automatically adjust some parameters: "low":
                        for genus-/species-/strain-level phylogenies; "medium": for class-/order-level phylogenies;
                        "high": for phylum-/tree-of-life size phylogenies (default: None)
  --strainphlan         The inputs are aligned markers from StrainPhlAn (default: False)
  --accurate            Use more phylogenetic signal which can result in more accurate phylogeny; affected parameters
                        depend on the "--diversity" level (default: False)
  --fast                Perform more a faster phylogeny reconstruction by reducing the phylogenetic positions to use;
                        affected parameters depend on the "--diversity" level (default: False)
  --clean_all           Remove all installation and database files automatically generated (default: False)
  --database_list       List of all the available databases that can be specified with the -d/--database option
                        (default: False)
  -s SUBMAT, --submat SUBMAT
                        Specify the substitution matrix to use, available substitution matrices can be listed with "--
                        submat_list" (default: None)
  --submat_list         List of all the available substitution matrices that can be specified with the -s/--submat
                        option (default: False)
  --submod_list         List of all the available substitution models that can be specified with the --maas option
                        (default: False)
  --nproc NPROC         The number of cores to use (default: 1)
  --min_num_proteins MIN_NUM_PROTEINS
                        Proteomes with less than this number of proteins will be discarded (default: 1)
  --min_len_protein MIN_LEN_PROTEIN
                        Proteins in proteomes shorter than this value will be discarded (default: 50)
  --min_num_markers MIN_NUM_MARKERS
                        Input genomes or proteomes that map to less than the specified number of markers will be
                        discarded (default: 1)
  --trim {gap_trim,gap_perc,not_variant,greedy}
                        Specify which type of trimming to perform: "gap_trim": execute what specified in the "trim"
                        section of the configuration file; "gap_perc": remove columns with a percentage of gaps above
                        a certain threshold (see "--gap_perc_threshold" parameter)"not_variant": remove columns with
                        at least one nucleotide/amino acid appearing above a certain threshold (see "--
                        not_variant_threshold" parameter); "greedy": performs all the above trimming steps; If not
                        specified, no trimming will be performed (default: None)
  --gap_perc_threshold GAP_PERC_THRESHOLD
                        Specify the value used to consider a column not variant when "--trim not_variant" is specified
                        (default: 0.8)
  --not_variant_threshold NOT_VARIANT_THRESHOLD
                        Specify the value used to consider a column not variant when "--trim not_variant" is specified
                        (default: 0.99)
  --subsample {phylophlan,onethousand,sevenhundred,fivehundred,threehundred,onehundred,fifty,twentyfive,tenpercent,twentyfivepercent,fiftypercent,full}
                        The number of positions to retain from each single marker, available option are: "phylophlan":
                        specific number of positions for each PhyloPhlAn marker (only when "--database phylophlan");
                        "onethousand": return the top 1000 positions; "sevenhundred": return the top 700;
                        "fivehundred": return the top 500; "threehundred" return the top 300; "onehundred": return the
                        top 100 positions; "fifty": return the top 50 positions; "twentyfive": return the top 25
                        positions; "fiftypercent": return the top 50 percent positions; "twentyfivepercent": return
                        the top 25% positions; "tenpercent": return the top 10% positions; "full": full alignment.
                        (default: full)
  --unknown_fraction UNKNOWN_FRACTION
                        Define the amount of unknowns ("X" and "-") allowed in each column of the MSA of the markers
                        (default: 0.3)
  --scoring_function {trident,muscle,random}
                        Specify which scoring function to use to evaluate columns in the MSA results (default: None)
  --sort                If specified, the markers will be ordered, when using the PhyloPhlAn database, it will be
                        automatically set to "True" (default: False)
  --remove_fragmentary_entries
                        If specified the MSAs will be checked and cleaned from fragmentary entries. See
                        --fragmentary_threshold for the threshold values above which an entry will be considered
                        fragmentary (default: False)
  --fragmentary_threshold FRAGMENTARY_THRESHOLD
                        The fraction of gaps in the MSA to be considered fragmentary and hence discarded (default:
                        0.85)
  --min_num_entries MIN_NUM_ENTRIES
                        The minimum number of entries to be present for each of the markers in the database (default:
                        4)
  --maas MAAS           Select a mapping file that specifies the substitution model of amino acid to use for each of
                        the markers for the gene tree reconstruction. File must be tab-separated (default: None)
  --remove_only_gaps_entries
                        If specified, entries in the MSAs composed only of gaps ("-") will be removed. This is
                        equivalent to specify "--remove_fragmentary_entries --fragmentary_threshold 1" (default:
                        False)
  --mutation_rates      If specified will produced a mutation rates table for each of the aligned markers and a
                        summary table for the concatenated MSA. This operation can take a long time to finish
                        (default: False)
  --force_nucleotides   If specified force PhyloPhlAn to use nucleotide sequences for the phylogenetic analysis, even
                        in the case of a database of amino acids (default: False)
  --convert_N2gap       If specified Ns will be forced to gaps (-) after the MSAs and only whit nucleotides MSAs
                        (default: False)
  --update              Update the databases file (default: False)
  --citation            Show citation
  --verbose             Makes PhyloPhlAn verbose (default: False)
  -v, --version         Prints the current PhyloPhlAn version and exit

Folder paths:
  Parameters for setting the folder locations

  --input_folder INPUT_FOLDER
                        Path to the folder containing the input data (default: input/)
  --data_folder DATA_FOLDER
                        Path to the folder where to store the intermediate files, default is "tmp" inside the
                        project's output folder (default: None)
  --databases_folder DATABASES_FOLDER
                        Path to the folder containing the database files (default: phylophlan_databases/)
  --submat_folder SUBMAT_FOLDER
                        Path to the folder containing the substitution matrices to use to compute the column score for
                        the subsampling step (default: phylophlan_substitution_matrices/)
  --submod_folder SUBMOD_FOLDER
                        Path to the folder containing the mapping file with substitution models for each marker for
                        the gene tree building (default: phylophlan_substitution_models/)
  --configs_folder CONFIGS_FOLDER
                        Path to the folder containing the configuration files (default: phylophlan_configs/)
  --output_folder OUTPUT_FOLDER
                        Path to the output folder where to save the results (default: )

Filename extensions:
  Parameters for setting the extensions of the input files

  --genome_extension GENOME_EXTENSION
                        Extension for input genomes (default: .fna)
  --proteome_extension PROTEOME_EXTENSION
                        Extension for input proteomes (default: .faa)

    ]]></help>
    <citations>
        <citation type="doi">10.1038/s41467-020-16366-7</citation>
    </citations>
</tool>